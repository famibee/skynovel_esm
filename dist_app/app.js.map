{"version":3,"file":"app.js","names":["#hInfo","#em","#ipc","#fetch2web","#fetchAb2web","#setStore","mbo: MessageBoxOptions","#idxjs_found","#idxjs_not_found","#dl_start","#dl_app","#dl_comp","a: Promise<void>[]"],"sources":["../node_modules/@electron-toolkit/typed-ipc/dist/renderer.mjs","../src/sn/SysApp.ts"],"sourcesContent":["/**\n * Typed emitter for Electron `ipcRenderer`.\n */\nclass IpcEmitter {\n    send(channel, ...args) {\n        window.electron.ipcRenderer.send(channel, ...args);\n    }\n    invoke(channel, ...args) {\n        return window.electron.ipcRenderer.invoke(channel, ...args);\n    }\n}\n/**\n * Typed listener for Electron `ipcRenderer`.\n */\nclass IpcListener {\n    on(channel, listener) {\n        return window.electron.ipcRenderer.on(channel, listener);\n    }\n    once(channel, listener) {\n        return window.electron.ipcRenderer.once(channel, listener);\n    }\n}\n\nexport { IpcEmitter, IpcListener };\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport  type {T_HINFO} from '../appMain_cmn';\nimport {SysBase} from './SysBase';\nimport {CmnLib, getDateStr, argChk_Boolean, argChk_Num, uint} from './CmnLib';\nimport type {T_HTag, TTag} from './Grammar';\nimport type {T_Variable, T_Data4Vari, T_Main, T_SysBaseParams, T_SysBaseLoadedParams, T_H_TMP_DATA} from './CmnInterface';\nimport {creSYS_DATA} from './CmnInterface';\nimport type {SAVE_WIN_INF, T_FETCH, T_IpcEvents, T_IpcRendererEvent} from '../preload';\nimport {DebugMng} from './DebugMng';\nimport {PROTOCOL_USERDATA} from './Config';\n\nimport type {Application, Loader} from 'pixi.js';\nimport type {IpcRendererEvent, MessageBoxOptions} from 'electron/renderer';\nimport {IpcListener, IpcEmitter} from '@electron-toolkit/typed-ipc/renderer'\nimport type {readFile} from 'fs-extra';\n\n\nconst\tFLD_CRYPT_DOC\t= 'doc_crypto';\n\ntype T_upd__index_json_pkg = {\n\t[pkg_name: string]: {\n\t\tpath\t: string;\n\t\tsize\t: number;\n\t\tsha512\t: string;\n\t\tcn\t\t: string;\n\t};\n\t// 'win32_x64': {\n\t// \t'path': 'xxx-1.0.0-x64.exe',\n\t// \t'size': 23892...,\n\t// \t'sha512': 'GVaqx...',\n\t// \t'cn': 'YTNm...'\n\t// }\n}\ntype T_upd__index_json = T_upd__index_json_pkg & {\n\tversion\t: string;\n\tname\t: string;\n}\n\n\n\t// console.log はアプリのコンソールに出る\nexport class SysApp extends SysBase {\n\tconstructor(...[hPlg = {}, arg = {cur: 'prj/', crypto: false, dip: ''}]: T_SysBaseParams) {\t// DOMContentLoaded は呼び出し側でやる\n\t\tsuper(hPlg, arg);\n\n\t\tvoid this.loaded(hPlg, arg);\n\t}\n\tprotected override async loaded(...[hPlg, arg]: T_SysBaseLoadedParams) {\n\t\tawait super.loaded(hPlg, arg);\n\n\t\tthis.#hInfo = await this.#em.invoke('getInfo');\n\t\tCmnLib.isPackaged = this.#hInfo.isPackaged;\n\t\t// this.arg = arg = {...arg, cur: this.#hInfo.getAppPath.replaceAll('\\\\', '/') + (CmnLib.isPackaged ?'/doc/' :'/')+ arg.cur};\n\n\t\tthis.#ipc.on('log', (_: IpcRendererEvent, arg: unknown)=> console.info('main: %o', arg));\n\n\t\tthis.$path_downloads = this.#hInfo.downloads.replaceAll('\\\\', '/') +'/';\n\n\t\tCmnLib.isDbg = Boolean(this.#hInfo.env.SKYNOVEL_DBG) && ! CmnLib.isPackaged;\t// 配布版では無効\n\t\tif (CmnLib.isDbg) this.extPort = uint(this.#hInfo.env.SKYNOVEL_PORT ?? '3776');\n\n\t\tawait this.run();\n\t}\n\t#hInfo:  T_HINFO = {\n\t\tgetAppPath\t: '',\n\t\tisPackaged\t: false,\n\t\tdownloads\t: '',\n\t\tuserData\t: '',\n\t\tgetVersion\t: '',\n\t\tenv\t\t\t: {},\n\t\tplatform\t: '',\n\t\tarch\t\t: '',\n\t};\n\n\t// === vite-electron 用コード ===\n\treadonly\t#em\t\t= new IpcEmitter<T_IpcEvents>;\n\treadonly\t#ipc\t= new IpcListener<T_IpcRendererEvent>;\n\n\toverride use4ViteElectron(src: string, path: string, ld: Loader, main: T_Main) {\n\t\tif (! src.startsWith(PROTOCOL_USERDATA)) return false;\n\n\t\tld.use((res, next)=> void this.readFile(path, <Parameters<typeof readFile>[1]><unknown>'base64')\n\t\t.then((base64 : string)=> {\n\t\t\tconst img = new Image;\n\t\t\timg.src = `data:image/${path.endsWith('.png') ?'png' :'jpeg'};base64,${base64}`;\n\t\t\tres.data = img;\n\t\t})\n\t\t.catch((e: unknown)=> main.errScript(`FrameMng use ロード失敗です fn:${res.name} ${String(e)}`, false))\n\t\t.finally(()=> next()));\n\n\t\treturn true;\n\t}\n\treadonly\t#fetch2web = (url: string)=> this.#em.invoke('fetch', url);\n\treadonly\t#fetchAb2web = (url: string)=> this.#em.invoke('fetchAb', url);\n\n\toverride\treadonly\tensureFile\t= (path: string)=> this.#em.invoke('ensureFile', path);\n\t// === vite-electron 用コード ===\n\tprotected\tasync readFile(path: string, encoding: Parameters<typeof readFile>[1]) {\n\t\treturn this.#em.invoke('readFile', path, encoding);\n\t}\n\tprotected\treadonly\twriteFile\t= (path: string, data: string | NodeJS.ArrayBufferView, o?: object)=> this.#em.invoke('writeFile', path, data, o);\n\toverride\treadonly\tappendFile\t= (path: string, data: string)=> this.#em.invoke('appendFile', path, data);\n\toverride\treadonly\toutputFile\t= (path: string, data: string)=> this.#em.invoke('outputFile', path, data);\n\n\toverride readonly\tisApp = true;\n\tprotected \toverride $path_userdata\t\t= '';\n\tprotected\toverride $path_downloads\t= '';\n\n\toverride async\tinitVal(hTmp: T_H_TMP_DATA, comp: (data: T_Data4Vari)=> void) {\n\t\t// システム情報\n\t\thTmp['const.sn.isDebugger'] = false;\n\t\t\t// システムがデバッグ用の特別なバージョンか\n\t\t\t// AIRNovel の const.flash.system.Capabilities.isDebugger\n\n\t\tthis.$path_userdata\t= CmnLib.isDbg\n\t\t\t? this.#hInfo.getAppPath.slice(0, -3) +'.vscode/'\t// /doc → /\n\t\t\t: this.#hInfo.userData.replaceAll('\\\\', '/') +'/';\n\n\t\tthis.flushSub = ()=> {\n\t\t\tvoid this.#em.invoke('flush', JSON.parse(JSON.stringify(this.data)));\n\t\t}\t// 関数や undefined を無視してくれるので、structuredClone() よりいい動作\n\t\tawait this.#setStore();\n\t\tconst first = hTmp['const.sn.isFirstBoot']\n\t\t= await this.#em.invoke('Store_isEmpty');\n\t\tif (first) {\n\t\t\t// データがない（初回起動）場合の処理\n\t\t\tthis.data.sys = creSYS_DATA();\n\t\t\tthis.data.mark = {};\n\t\t\tthis.data.kidoku = {};\n\t\t}\n\t\telse {\n\t\t\t// データがある場合の処理\n\t\t\tconst o = <T_Data4Vari>await this.#em.invoke('Store_get');\n\t\t\tthis.data.sys = o.sys;\n\t\t\tthis.data.mark = o.mark;\n\t\t\tthis.data.kidoku = o.kidoku;\n\t\t}\n\n\t\t// ウインドウ位置\n\t\tconst x = argChk_Num(this.data.sys, 'const.sn.nativeWindow.x', 0);\n\t\t//const x = Number(this.val.getVal(\t// ここではまだ使えない\n\t\tconst y = argChk_Num(this.data.sys, 'const.sn.nativeWindow.y', 0);\n\t\tconst w = this.data.sys['const.sn.nativeWindow.w'] || CmnLib.stageW;\n\t\tconst h = this.data.sys['const.sn.nativeWindow.h'] || CmnLib.stageH;\n\n\t\tthis.#ipc.on('save_win_inf', (_e: IpcRendererEvent, {x, y, w, h}: SAVE_WIN_INF)=> {\n// console.log(`fn:SysApp.ts save_win_inf (${x},${y},${w},${h})`);\n\t\t\tthis.data.sys['const.sn.nativeWindow.x'] = x;\n\t\t\tthis.data.sys['const.sn.nativeWindow.y'] = y;\n\t\t\tthis.data.sys['const.sn.nativeWindow.w'] = w;\n\t\t\tthis.data.sys['const.sn.nativeWindow.h'] = h;\n\n\t\t\t// ・画面サイズ：screen.width ウインドウが表示されているディスプレイのサイズ\n\t\t\t//\t※ macOSなら【設定】-【ディスプレイ】-【使用形態】のイメージボタンにホバーすると出る数字と同じ\n// DebugMng.myTrace(`fn:SysApp.ts 画面サイズ(${String(screen.width)} x ${String(screen.height)}) 利用可能領域(${String(screen.availWidth)} x ${String(screen.availHeight)})`, 'W');\n\t\t\thTmp['const.sn.screenResolutionX'] = screen.availWidth;\t// 画面の最大水平解像度\n\t\t\thTmp['const.sn.screenResolutionY'] = screen.availHeight;\t// 画面の最大垂直解像度\n\t\t\t\t// AIRNovel の const.flash.system.Capabilities.screenResolutionX、Y\n\t\t\t\t// 上のメニューバーは含んでいない（たぶん an も）。含むのは workAreaSize\n\n\t\t\tcomp(this.data);\n\t\t});\n\n// console.log(`fn:SysApp.ts to_app.inited(${x},${y},${w},${h})`);\n\t\tawait this.#em.invoke('inited', this.cfg.oCfg, {c: first, x, y, w, h});\n\t}\n\treadonly\t#setStore = ()=> this.#em.invoke('Store', {\n\t\tcwd\t: this.$path_userdata +'storage',\n\t\tname: this.arg.crypto ?'data_' :'data',\n\t\tencryptionKey: this.arg.crypto ?this.stk() :undefined,\n\t});\n\n\n\toverride init(hTag: T_HTag, appPixi: Application, val: T_Variable) {\n\t\tconst ret = super.init(hTag, appPixi, val);\n\t\tdocument.body.style.backgroundColor = '#000';\n\n\t\tthis.#ipc.on('shutdown', (_e: IpcRendererEvent)=> this.main?.destroy());\n\n\t\tconst ev = new MouseEvent('click');\n\t\tthis.#ipc.on('fire', (_e: IpcRendererEvent, KEY: string)=> this.fire(KEY, ev));\n\t\t//this.#ipc.on('call', (_e: IpcRendererEvent, fn: string, label: string)=> main.resumeByJumpOrCall({fn, label}));\t// 実験・保留コード。セキュリティ懸念\n\n\t\treturn ret;\n\t}\n\n\n\toverride cvsResize() {\n\t\tsuper.cvsResize();\n\n\t\tif (! this.main) return;\n\t\tconst cvs = this.main.cvs;\n\t\tconst ps = cvs.parentElement?.style;\n\t\tif (! ps) return;\n\t\tconst s = cvs.style;\n\t\tif (this.isFullScr) {\n\t\t\tps.position = '';\t// SysBaseを上書き\n\t\t\tps.width = '';\n\t\t\tps.height= '';\n\n\t\t\ts.position = 'fixed';\n\t\t\ts.left = `${String(this.ofsLeft4elm)}px`;\n\t\t\ts.top  = `${String(this.ofsTop4elm)}px`;\n\t\t}\n\t\telse {\n\t\t\tps.position = 'relative';\t// SysBaseを上書き\n\t\t\tps.width = `${String(this.cvsWidth)}px`;\n\t\t\tps.height= `${String(this.cvsHeight)}px`;\n\n\t\t\ts.position = 'relative';\n\t\t\ts.left = '';\n\t\t\ts.top  = '';\n\t\t}\n\t}\n\n\n\toverride readonly copyBMFolder = (from: number, to: number)=> {\n\t\tconst path_from = `${this.$path_userdata}storage/${String(from)}/`;\n\t\tconst path_to = `${this.$path_userdata}storage/${String(to)}/`;\n\t\tvoid this.#em.invoke('existsSync', path_from).then(async v=> {\n\t\t\tif (v)  await this.#em.invoke('copy', path_from, path_to);\n\t\t});\n\t};\n\toverride readonly eraseBMFolder = (place: number)=> {\n\t\tvoid this.#em.invoke('remove', `${this.$path_userdata}storage/${String(place)}/`);\n\t};\n\n\t// アプリの終了\n\tprotected override readonly\tclose = ()=> {void this.#em.invoke('win_close'); return false}\n\n\t// プレイデータをエクスポート\n\tprotected override readonly\t_export = ()=> {\n\t\tvoid this.#em.invoke('zip',\n\t\t\tthis.$path_userdata +'storage/',\n\t\t\tthis.$path_downloads + (this.arg.crypto ?'' :'no_crypto_')\n\t\t\t+ this.cfg.headNs + getDateStr('-', '_', '') +'.spd',\n\t\t).then(()=> {\n\t\t\tif (CmnLib.debugLog) console.log('プレイデータをエクスポートしました');\n\t\t\tthis.fire('sn:exported', new MouseEvent('click'));\t// 末尾に処理\n\t\t});\n\n\t\treturn false;\n\t}\n\n\t// プレイデータをインポート\n\tprotected override readonly\t_import = ()=> {\n\t\tthis.#em.invoke('showOpenDialog', {\n\t\t\ttitle\t: 'play data import',\n\t\t\tfilters\t: [{name: 'sn import', extensions: ['spd']}],\n\t\t\tproperties: [\n\t\t\t\t'openFile',\t// - ファイルを選択するのを許可します。\n\t\t\t\t// openDirectory - ディレクトリを選択するのを許可します。\n\t\t\t\t// multiSelections - 複数のパスを選択するのを許可します。\n\t\t\t],\n\t\t}).then(async ({canceled, filePaths: [inp]})=> {\n\t\t\tif (canceled) return;\n\n\t\t\tconst bkFlush = ()=> this.flush();\n\t\t\tthis.flush = ()=> { /* empty */ };\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\t\t\tawait this.#em.invoke('unzip', inp!, this.$path_userdata +'storage/');\n\n\t\t\tawait this.#setStore();\n\t\t\tconst o = <T_Data4Vari>await this.#em.invoke('Store_get');\n\t\t\tthis.data.sys = o.sys;\n\t\t\tthis.data.mark = o.mark;\n\t\t\tthis.data.kidoku = o.kidoku;\n\t\t\tthis.flush = bkFlush;\n\t\t\tthis.flush();\n\t\t\tthis.val.updateData(o);\n\n\t\t\tif (CmnLib.debugLog) console.log('プレイデータをインポートしました');\n\t\t\tthis.fire('sn:imported', new MouseEvent('click'));\n\t\t})\n\t\t.catch((e: unknown)=> console.log(`[import] err: ${String(e)}`));\n\n\t\treturn false;\n\t}\n\n\t// ＵＲＬを開く\n\tprotected override readonly\tnavigate_to: TTag = hArg=> {\n\t\tconst {url} = hArg;\n\t\tif (! url) throw '[navigate_to] urlは必須です';\n\n\t\tvoid this.#em.invoke('navigate_to', url);\n\n\t\treturn false;\n\t}\n\t// タイトル指定\n\tprotected override titleSub(title: string) {void this.#em.invoke('win_setTitle', title)}\n\n\t// 全画面状態切替\n\tprotected override readonly\ttglFlscr_sub\n\t= async ()=> this.#em.invoke('isSimpleFullScreen').then(async isFS=> {\n\t\tthis.isFullScr = ! isFS;\n\t\tawait this.#em.invoke('setSimpleFullScreen', this.isFullScr);\n\t});\n\n\n\t// 更新チェック\n\tprotected override readonly\tupdate_check: TTag = hArg=> {\n\t\tconst {url} = hArg;\n\t\tif (! url) throw '[update_check] urlは必須です';\n\t\tif (! url.endsWith('/')) throw '[update_check] urlの末尾は/にして下さい';\n\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] url=${url}`, 'D');\n\n\t\tvoid this.#fetch2web(url +'_index.json')\n\t\t.then(async o=> {\n\t\t\tconst mbo: MessageBoxOptions = {\n\t\t\t\ttitle\t: 'アプリ更新',\n\t\t\t\ticon\t: this.#hInfo.getAppPath +`/${\n\t\t\t\t\tthis.arg.crypto ?FLD_CRYPT_DOC :'doc'\n\t\t\t\t}/icon.png`,\n\t\t\t\tbuttons\t: ['OK', 'Cancel'],\n\t\t\t\tdefaultId\t: 0,\n\t\t\t\tcancelId\t: 1,\n\t\t\t\tmessage\t: `アプリ【${this.cfg.oCfg.book.title}】に更新があります。\\nダウンロードしますか？`,\n\t\t\t};\n\t\t\tif (o.ok) await this.#idxjs_found(o, url, mbo);\n\t\t\telse await this.#idxjs_not_found(url, mbo);\n\t\t})\n\t\t.catch((e: unknown)=> DebugMng.myTrace(String(e), 'ET'));\n\n\t\treturn false;\n\t}\n\tasync #idxjs_found(o: T_FETCH, url: string, mbo: MessageBoxOptions) {\n\t\tif (CmnLib.debugLog) DebugMng.myTrace('[update_check] _index.jsonを取得しました', 'D');\n\t\tconst oIdx = <T_upd__index_json>JSON.parse(o.txt);\n\t\tif (! await this.#dl_start(oIdx.version, mbo)) return;\n\n\t\tconst key = this.#hInfo.platform +'_'+ this.#hInfo.arch;\n\t//\tconst key = this.#hInfo.platform +'_@'+ this.#hInfo.arch;\n\t\t\t// アーキテクチャがない場合の動作テスト\n\t\tconst k = oIdx[key];\n\t\tif (k) {\n\t\t\tconst {cn, path} = k;\n\t\t\tawait this.#dl_app(url, key +'-'+ cn, path);\n\t\t\tawait this.#dl_comp(mbo);\n\t\t\treturn;\n\t\t}\n\n\t\tlet d = '';\n\t\tconst regOldSameKey = new RegExp('^'+ this.#hInfo.platform +'_');\n\t\tconst a: Promise<void>[] = Object.entries(<{[nm: string]: {\n\t\t\tpath: string,\n\t\t\tcn\t: string,\n\t\t}}>oIdx)\n\t\t.flatMap(([nm, {path, cn}])=> {\n\t\t\tif (! regOldSameKey.test(nm)) return [];\n\t\t\td += '\\n- '+ path;\n\t\t\treturn this.#dl_app(url, nm +'-'+ cn, path);\n\t\t});\n\n\t\tmbo.message = `CPU = ${this.#hInfo.arch}\\nに対応するファイルが見つかりません。同じOSのファイルをすべてダウンロードしますか？`;\n\t\tmbo.detail = `${String(a.length)} 個ファイルがあります`+ d;\n\t\tconst {response} = await this.#em.invoke('showMessageBox', mbo);\n\t\tif (response > 0) return;\n\n\t\tawait Promise.allSettled(a);\n\t\tawait this.#dl_comp(mbo);\n\t}\n\tasync #idxjs_not_found(url: string, mbo: MessageBoxOptions) {\n\t\tconst o = await this.#fetch2web(url +`latest${CmnLib.isMac ?'-mac' :''}.yml`);\n\t\tif (! o.ok) {\n\t\t\tif (CmnLib.debugLog) throw '[update_check] .ymlが見つかりません';\n\t\t\treturn;\n\t\t}\n\t\tif (CmnLib.debugLog) DebugMng.myTrace('[update_check] .ymlを取得しました', 'D');\n\t\tconst sYml = o.txt;\n\t\tconst mv = /version: (.+)/.exec(sYml);\n\t\tconst mv2 = mv?.[1];\n\t\tif (! mv2) throw '[update_check] .yml に version が見つかりません';\n\n\t\tif (! await this.#dl_start(mv2, mbo)) return;\n\n\n\t\tconst mp = /path: (.+)/.exec(sYml);\n\t\tif (! mp) throw '[update_check] path が見つかりません';\n\t\tconst [,path] = mp;\n\t\tif (! path) throw '[update_check] path が見つかりません.';\n\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] path=${path}`, 'D');\n\n\t\tconst mc = /sha512: (.+)/.exec(sYml);\n\t\tif (! mc) throw '[update_check] sha512 が見つかりません';\n\t\tconst [,sha] = mc;\n\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] sha=${sha ?? ''}=`, 'D');\n\n\t\t// (id)-1.0.0-arm64.dmg\n\t\tconst [,id, arch] = /(.+)(\\.\\w+)/.exec(path) ?? ['', '', ''];\n\t\tawait this.#dl_app(url, id + '-' + this.#hInfo.arch + arch, path);\n\t\tawait this.#dl_comp(mbo);\n\t}\n\n\tasync #dl_start(netver: string, mbo: MessageBoxOptions): Promise<boolean> {\n\t\tconst appver = this.#hInfo.getVersion;\n\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] 現在ver=${appver} 新規ver=${netver}`, 'D');\n\t\tif (netver === appver) {\n\t\t\tif (CmnLib.debugLog) DebugMng.myTrace('[update_check] バージョン更新なし', 'I');\n\t\t\treturn false;\n\t\t}\n\n\t\tmbo.detail = `現在 NOW ver ${appver}\\n新規 NEW ver ${netver}`;\n\t\tconst {response} = await this.#em.invoke('showMessageBox', mbo);\n\t\tif (response > 0) return false;\n\n\t\t// アプリダウンロード\n\t\tif (CmnLib.debugLog) DebugMng.myTrace('[update_check] アプリダウンロード開始', 'D');\n\n\t\treturn true;\n\t}\n\tasync #dl_app(url: string, urlApp: string, fn: string) {\n\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] アプリファイルDL試行... url=${url + urlApp}`, 'D');\n\t\tconst o = await this.#fetchAb2web(url + urlApp);\n\t\tif (! o.ok) {\n\t\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] アプリファイルが見つかりません url=${url + fn}`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst pathDL = this.#hInfo.downloads +'/'+ fn;\n\t\tif (CmnLib.debugLog) DebugMng.myTrace(`[update_check] pathDL=${pathDL}`, 'D');\n\n\t\tawait this.writeFile(pathDL, new DataView(o.ab));\n\t}\n\tasync #dl_comp(mbo: MessageBoxOptions) {\n\t\tif (CmnLib.debugLog) DebugMng.myTrace('アプリファイルを保存しました', 'D');\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\t\tmbo.buttons!.pop();\n\t\tmbo.message = `アプリ【${this.cfg.oCfg.book.title}】の更新パッケージを\\nダウンロードしました`;\n//\t\t\tmbo.message = `アプリ【${this.cfg.oCfg.book.title}】の更新パッケージを\\nダウンロードしました`+ (isOk ?'' :'が、破損しています。\\n開発元に連絡してください');\n\t\tawait this.#em.invoke('showMessageBox', mbo);\n\t}\n\n\t// アプリウインドウ設定\n\tprotected override readonly\twindow: TTag = hArg=> {\n\t\tconst x = argChk_Num(hArg, 'x', Number(this.val.getVal('sys:const.sn.nativeWindow.x', 0)));\n\t\tconst y = argChk_Num(hArg, 'y', Number(this.val.getVal('sys:const.sn.nativeWindow.y', 0)));\n\t\tconst w = argChk_Num(hArg, 'w', Number(this.val.getVal('sys:const.sn.nativeWindow.w', CmnLib.stageW)));\n\t\tconst h = argChk_Num(hArg, 'h', Number(this.val.getVal('sys:const.sn.nativeWindow.h', CmnLib.stageH)));\n\t\tthis.#em.invoke('window', argChk_Boolean(hArg, 'centering', false), x, y, CmnLib.stageW, CmnLib.stageH)\n\t\t.catch((e: unknown)=> DebugMng.myTrace(String(e), 'ET'));\n\t\tthis.val.setVal_Nochk('sys', 'const.sn.nativeWindow.x', x);\n\t\tthis.val.setVal_Nochk('sys', 'const.sn.nativeWindow.y', y);\n\t\tthis.val.setVal_Nochk('sys', 'const.sn.nativeWindow.w', w);\n\t\tthis.val.setVal_Nochk('sys', 'const.sn.nativeWindow.h', h);\n\t\tthis.flush();\n\n\t\treturn false;\n\t}\n\n\toverride capturePage(path: string, w: number, h: number, fnc: ()=> void) {\n\t\tvoid this.#em.invoke('capturePage', path, w, h).then(()=> fnc());\n\t}\n\n\toverride async savePic(path: string, data_url: string) {\n\t\tconst bs64 = data_url.slice(data_url.indexOf(',', 20) +1);\n\t\tawait this.ensureFile(path);\n\t\tawait this.writeFile(path, bs64);\n\t\tif (CmnLib.debugLog) console.log(`画像ファイル ${path} を保存しました`);\n\t}\n\n}\n"],"x_google_ignoreList":[0],"mappings":"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"}